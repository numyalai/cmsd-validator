<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        video{
            width: 640px;
            height: 360px;
        }
    </style>
</head>
<body>
    <div>
        <video id="videoElement" controls loop muted></video>
    </div>
    <script src="http://cdn.dashjs.org/latest/dash.all.min.js"></script>
    <script>
        const videoElement = document.getElementById('videoElement');
        const dashPlayer = dashjs.MediaPlayer().create();

        dashPlayer.initialize(videoElement, 'http://localhost:8080/cmsdValidator/media/vod/bbb_30fps_akamai/bbb_30fps.mpd', false);
        //dashPlayer.initialize(videoElement, 'https://dash.akamaized.net/akamai/bbb_30fps/bbb_30fps.mpd', false);

        // Enable XHR debugging
        // console.log(dashPlayer);
        // console.log(dashPlayer.getSettings());

        setInterval(() => {
            var metrics = dashPlayer.getDashMetrics()
            console.log(metrics.getHttpRequests("video"))

            const x = metrics.getHttpRequests("video")

            const headersString =x.pop()._responseHeaders

            function parseHeaders(headersString) {
                const headersArray = headersString.split('\r\n');
                const headersObj = {};

                headersArray.forEach(header => {
                    const [key, ...valueParts] = header.split(': ');
                    const value = valueParts.join(': '); // Reconstruct the original value (it may contain ':')
                    headersObj[key] = value;
                });

                return headersObj;
            }

            const headersJSON = parseHeaders(headersString);
          //  console.log(headersJSON);

            // Parse cmsd-dynamic value
            const cmsdDynamicValue = headersJSON["cmsd-dynamic"];
            const modifiedCmsdDynamicValue = cmsdDynamicValue.replace(/\\"/g, '"');
            const cmsdDynamicObject = {};
            modifiedCmsdDynamicValue.split(';').forEach(pair => {
                const [key, value] = pair.split('=');
                cmsdDynamicObject[key] = value;
            });

            console.log(cmsdDynamicObject);

            // Parse cmsd-static value
            const cmsdStaticValue = headersJSON["cmsd-static"];
            const modifiedCmsdStaticValue = cmsdStaticValue.replace(/\\"/g, '"');
            const cmsdStaticObject = {};
            modifiedCmsdStaticValue.split(',').forEach(pair => {
                const [key, value] = pair.split('=');
                cmsdStaticObject[key] = value;
            });

            console.log(cmsdStaticObject);

         //   console.log("HTTP Request Headers"  + Object.keys(metrics.getHttpRequests("video")))
            console.log("#############")
        }, 3000)

        // console.log(dashPlayer.getDebug());
        //console.log(dashPlayer.getDashAdapter());

        // const xhrLoader = dashjs.XHRLoader;
        // console.log(dashPlayer)

        // xhrLoader.prototype.load = function (request) {
        // console.log('Service Response:', request);
        
        // dashjs.XHRLoader.prototype.load.call
        // (xhrLoader, request);
        // };
    </script>
    <!-- <script>
        const videoElement = document.getElementById('videoElement');
        const dashPlayer = dashjs.MediaPlayer().create();
        dashPlayer.initialize(videoElement, 'http://10.42.0.1:8080/eins/zwei/media/vod/bbb_30fps_akamai/bbb_30fps.mpd', false);

        // Enable XHR debugging
        const xhrLoader = dashjs.XHRLoader;
        console.log(dashjs);

        xhrLoader.prototype.load = function (request) {
        console.log('Service Response:', request);
        
        const xhr = new XMLHttpRequest();
        
        xhr.open
        (request.method, request.url, true);
        
        // Log the received headers
        xhr.onload = function() {
            const headers = xhr.getAllResponseHeaders();
            console.log('Received Headers:', headers);
        };
        
        xhr.send();
        }; 
    </script> -->
    
</body>
</html>